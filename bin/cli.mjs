#!/usr/bin/env node

/**
 * CLI for @millken/inertia-vue
 * 
 * Commands:
 *   generate   - Scan pages/ directory and generate module registries
 *   build-ssr  - Build SSR bundle using default config (or project's ssr-build.ts)
 */

import fs from 'fs'
import path from 'path'

const args = process.argv.slice(2)
const command = args[0]

function toPascalCase(str) {
  return str
    .split(/[^a-zA-Z0-9]+/)
    .filter(Boolean)
    .map(s => s.charAt(0).toUpperCase() + s.slice(1))
    .join('')
}

/**
 * Recursively scan a directory for .vue files.
 */
function scanPages(dir, basePath = '') {
  const modules = {}
  if (!fs.existsSync(dir)) return modules

  const items = fs.readdirSync(dir)
  for (const item of items) {
    const fullPath = path.join(dir, item)
    const stat = fs.statSync(fullPath)
    if (stat.isDirectory()) {
      Object.assign(modules, scanPages(fullPath, basePath ? `${basePath}/${item}` : item))
    } else if (item.endsWith('.vue')) {
      const name = item.replace('.vue', '')
      const moduleName = basePath ? `${basePath}/${name}` : name
      modules[moduleName] = fullPath
    }
  }
  return modules
}

function generateCommand() {
  const cwd = process.cwd()
  
  // Configurable paths via args or defaults
  const pagesDir = path.resolve(cwd, args[1] || 'pages')
  const clientOutput = path.resolve(cwd, args[2] || 'src/inertia/modules.ts')
  const ssrOutput = path.resolve(cwd, args[3] || 'ssr-modules.ts')

  const modules = scanPages(pagesDir)
  const keys = Object.keys(modules).sort()

  // === Client async modules ===
  let clientContent = `import type { Component } from 'vue';\n\n`
  clientContent += `// Auto-generated by @millken/inertia-vue — do not edit manually\n`
  clientContent += `export const modules: Record<string, () => Promise<Component>> = {\n\n`

  for (const name of keys) {
    let rel = path.relative(path.dirname(clientOutput), modules[name]).replace(/\\/g, '/')
    if (!rel.startsWith('.') && !rel.startsWith('/')) rel = './' + rel
    clientContent += `  '${name}': () => import('${rel}'),\n`
  }
  clientContent += `}\n`

  const clientDir = path.dirname(clientOutput)
  if (!fs.existsSync(clientDir)) fs.mkdirSync(clientDir, { recursive: true })
  fs.writeFileSync(clientOutput, clientContent, 'utf8')
  console.log(`Generated client modules: ${clientOutput}`)

  // === SSR sync modules ===
  const imports = []
  const entries = []
  const usedIds = new Map()

  for (const name of keys) {
    const idBase = toPascalCase(name)
    let id = idBase || 'Page'
    if (/^[0-9]/.test(id)) id = '_' + id
    if (usedIds.has(id)) {
      const count = usedIds.get(id) + 1
      usedIds.set(id, count)
      id = id + count
    } else {
      usedIds.set(id, 0)
    }

    let rel = path.relative(path.dirname(ssrOutput), modules[name]).replace(/\\/g, '/')
    if (!rel.startsWith('.') && !rel.startsWith('/')) rel = './' + rel

    imports.push(`import ${id} from '${rel}'`)
    entries.push(`  '${name}': ${id},`)
  }

  let ssrContent = `import { Component } from 'vue'\n\n`
  if (imports.length > 0) ssrContent += imports.join('\n') + '\n\n'
  ssrContent += `const modules: Record<string, Component> = {\n${entries.join('\n')}\n}\n\nexport default modules\n`

  fs.writeFileSync(ssrOutput, ssrContent, 'utf8')
  console.log(`Generated SSR modules: ${ssrOutput}`)
  console.log(`Found ${keys.length} page modules`)
}

async function buildSSRCommand() {
  // Try to load project's ssr-build config, otherwise use defaults
  const cwd = process.cwd()
  const projectBuild = path.resolve(cwd, 'ssr-build.ts')
  
  if (fs.existsSync(projectBuild)) {
    // Project has its own ssr-build.ts — use tsx or esbuild-register to run it
    const { execSync } = await import('child_process')
    try {
      execSync(`npx tsx ${projectBuild}`, { stdio: 'inherit', cwd })
    } catch (e) {
      console.error('SSR build failed')
      process.exit(1)
    }
  } else {
    console.error('No ssr-build.ts found. Create one in your project root.')
    console.error('Example:\n')
    console.error(`  import { buildSSR } from '@millken/inertia-vue/ssr-build'`)
    console.error(`  import vuePlugin from 'millken-esbuild-plugin-vue'`)
    console.error(`  buildSSR({ plugins: [vuePlugin()] })`)
    process.exit(1)
  }
}

switch (command) {
  case 'generate':
    generateCommand()
    break
  case 'build-ssr':
    buildSSRCommand()
    break
  default:
    console.log(`@millken/inertia-vue CLI\n`)
    console.log(`Commands:`)
    console.log(`  generate              Scan pages/ and generate module registries`)
    console.log(`  build-ssr             Build SSR bundle`)
    console.log(`\nUsage:`)
    console.log(`  npx inertia-vue generate [pagesDir] [clientOutput] [ssrOutput]`)
    console.log(`  npx inertia-vue build-ssr`)
    process.exit(command ? 1 : 0)
}
